<!DOCTYPE html>
<html lang="en" x-data="appData()">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TalkLet - Secure Messaging</title>
  <script src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1"></script>
  <script src="../Static/js/htmx.min.js"></script>
  <script src="../Static/js/alpine.min.js" defer></script>
  <link rel="stylesheet" href="../Static/css/index_main.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
</head>
<body>
  <div id="app" class="app-container" :class="{'dark-mode': darkMode, 'light-mode': !darkMode}">
    <!-- Left Navigation -->
    <div class="left-nav">
      <div class="app-logo">
        <i class="fas fa-comment-dots"></i>
      </div>
      <nav>
        <button @click="switchTab('chat')" :class="{active: currentTab === 'chat'}">
          <i class="fas fa-comment-alt"></i>
        </button>
        <button @click="switchTab('groups')" :class="{active: currentTab === 'groups'}">
          <i class="fas fa-users"></i>
        </button>
        <button @click="switchTab('location')" :class="{active: currentTab === 'location'}">
          <i class="fas fa-map-marker-alt"></i>
        </button>
        <button @click="switchTab('settings')" :class="{active: currentTab === 'settings'}">
          <i class="fas fa-cog"></i>
        </button>
      </nav>
      <div class="user-menu">
        <div class="profile" @click="toggleUserMenu">
          <img src="https://i.pravatar.cc/80?img=5" alt="Profile"/>
          <div class="status-indicator online"></div>
        </div>
        <div class="user-menu-dropdown" x-show="showUserMenu" @click.outside="showUserMenu = false">
          <button @click="toggleTheme">
            <i :class="darkMode ? 'fas fa-sun' : 'fas fa-moon'"></i>
            Switch Theme
          </button>
          <button @click="logout">
            <i class="fas fa-sign-out-alt"></i>
            Logout
          </button>
        </div>
      </div>
    </div>

    <!-- Chat List Sidebar -->
    <div class="sidebar" x-show="currentTab === 'chat'">
      <div class="search-bar">
        <i class="fas fa-search"></i>
        <input 
          type="text" 
          placeholder="Search chats..." 
          x-model="searchQuery"
          @input="filterChats"
        />
      </div>
      <div class="chat-list">
        <template x-for="chat in filteredChats" :key="chat.id">
          <div 
            class="chat-item" 
            :class="{'active': activeChat === chat.id}"
            @click="openChat(chat)"
          >
            <div class="avatar">
              <img :src="`https://i.pravatar.cc/80?img=${chat.id}`" :alt="chat.name"/>
              <div class="status-indicator" :class="chat.online ? 'online' : 'offline'"></div>
            </div>
            <div class="chat-info">
              <div class="chat-header">
                <h4 x-text="chat.name"></h4>
                <span class="time" x-text="formatTime(chat.lastMessageTime)"></span>
              </div>
              <div class="chat-preview">
                <p x-text="chat.lastMessage"></p>
                <span class="unread-count" x-show="chat.unread > 0" x-text="chat.unread"></span>
              </div>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- Chat Area -->
    <div class="chat-area" x-show="activeChat">
      <div class="chat-header">
        <div class="chat-partner">
          <div class="avatar">
            <img :src="`https://i.pravatar.cc/80?img=${activeChat}`" :alt="currentChat.name"/>
            <div class="status-indicator online"></div>
          </div>
          <div class="partner-info">
            <h3 x-text="currentChat.name"></h3>
            <p x-text="typing ? 'typing...' : 'online'"></p>
          </div>
        </div>
        <div class="chat-actions">
          <button @click="startCall('audio')">
            <i class="fas fa-phone"></i>
          </button>
          <button @click="startCall('video')">
            <i class="fas fa-video"></i>
          </button>
          <button @click="showChatOptions = !showChatOptions">
            <i class="fas fa-ellipsis-v"></i>
          </button>
          <div class="chat-options" x-show="showChatOptions" @click.outside="showChatOptions = false">
            <button @click="viewProfile">View Profile</button>
            <button @click="clearChat">Clear Chat</button>
            <button @click="deleteChat">Delete Chat</button>
          </div>
        </div>
      </div>

      <div class="messages" id="messages-container">
        <div class="date-divider">
          <span>Today</span>
        </div>
        
        <template x-for="message in currentChat.messages" :key="message.id">
          <div class="message" :class="{'sent': message.sent, 'received': !message.sent}">
            <div class="message-content">
              <p x-text="message.text"></p>
              <div class="message-meta">
                <span x-text="formatMessageTime(message.time)"></span>
                <template x-if="message.sent">
                  <i class="fas fa-check-double" :class="{'seen': message.seen}"></i>
                </template>
              </div>
            </div>
            <div class="message-actions">
              <button @click="showMessageMenu(message.id)">
                <i class="fas fa-ellipsis-v"></i>
              </button>
              <div class="message-menu" x-show="messageMenu === message.id" @click.outside="messageMenu = null">
                <button @click="replyToMessage(message)">Reply</button>
                <button @click="copyMessage(message)">Copy</button>
                <button @click="deleteMessage(message)" x-show="message.sent">Delete</button>
                <button @click="forwardMessage(message)">Forward</button>
              </div>
            </div>
          </div>
        </template>
      </div>

      <div class="message-input">
        <button class="attachment-btn" @click="showAttachments = !showAttachments">
          <i class="fas fa-paperclip"></i>
        </button>
        <div class="attachments-menu" x-show="showAttachments" @click.outside="showAttachments = false">
          <button @click="attachFile('photo')">
            <i class="fas fa-image"></i>
            Photo
          </button>
          <button @click="attachFile('camera')">
            <i class="fas fa-camera"></i>
            Camera
          </button>
          <button @click="attachFile('document')">
            <i class="fas fa-file"></i>
            Document
          </button>
          <button @click="attachFile('location')">
            <i class="fas fa-map-marker-alt"></i>
            Location
          </button>
        </div>
        
        <div class="input-container">
          <button class="emoji-btn" @click="showEmojiPicker = !showEmojiPicker">
            <i class="far fa-smile"></i>
          </button>
          <emoji-picker x-show="showEmojiPicker" class="emoji-picker"></emoji-picker>
          
          <input 
            type="text" 
            placeholder="Type a message..." 
            x-model="messageInput"
            @keyup.enter="sendMessage"
            @input="setTyping"
          />
        </div>
        
        <button class="send-btn" @click="sendMessage">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>

    <!-- Empty State -->
    <div class="empty-state" x-show="!activeChat && currentTab === 'chat'">
      <div class="empty-content">
        <div class="icon">
          <i class="fas fa-comment-dots"></i>
        </div>
        <h2>TalkLet</h2>
        <p>Connect with friends and family with end-to-end encrypted messaging</p>
        <button @click="findPeople">Find People Nearby</button>
      </div>
    </div>

    <!-- Location Tab -->
    <div class="location-tab" x-show="currentTab === 'location'">
      <div class="location-header">
        <h2>People Nearby</h2>
        <button @click="refreshLocation">
          <i class="fas fa-sync-alt"></i>
        </button>
      </div>
      <div class="map-container">
        <div class="map-placeholder">
          <i class="fas fa-map-marked-alt"></i>
          <p>Discover people around you</p>
        </div>
      </div>
      <div class="nearby-users">
        <template x-for="user in nearbyUsers" :key="user.id">
          <div class="nearby-user">
            <div class="user-avatar">
              <img :src="`https://i.pravatar.cc/80?img=${user.id}`" :alt="user.name"/>
              <div class="distance-badge" x-text="`${user.distance} km`"></div>
            </div>
            <div class="user-info">
              <h4 x-text="user.name"></h4>
              <p x-text="user.bio"></p>
            </div>
            <button class="connect-btn" @click="sendRequest(user.id)">
              Connect
            </button>
          </div>
        </template>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('appData', () => ({
        // App State
        darkMode: true,
        currentTab: 'chat',
        activeChat: null,
        showUserMenu: false,
        searchQuery: '',
        typing: false,
        messageInput: '',
        showEmojiPicker: false,
        showAttachments: false,
        showChatOptions: false,
        messageMenu: null,
        
        // Sample Data
        chats: [
          {
            id: 1,
            name: 'Jack',
            lastMessage: 'Hey there! How are you?',
            lastMessageTime: '2023-07-15T10:23:00',
            online: true,
            unread: 3,
            messages: [
              {
                id: 1,
                text: 'Hey there! How are you doing?',
                time: '2023-07-15T10:23:00',
                sent: false,
                seen: true
              },
              {
                id: 2,
                text: "I'm good! Just working on this new chat app.",
                time: '2023-07-15T10:24:00',
                sent: true,
                seen: true
              },
              {
                id: 3,
                text: "That sounds awesome! Can I see a demo?",
                time: '2023-07-15T10:25:00',
                sent: false,
                seen: true
              },
              {
                id: 4,
                text: "Sure! Here's a screenshot of what I have so far.",
                time: '2023-07-15T10:26:00',
                sent: true,
                seen: true
              },
              {
                id: 5,
                text: "What do you think?",
                time: '2023-07-15T10:26:30',
                sent: true,
                seen: false
              }
            ]
          },
          // More chats...
        ],
        
        nearbyUsers: [
          {
            id: 101,
            name: 'Alex Johnson',
            bio: 'Software Developer | Coffee Enthusiast',
            distance: 0.5,
            interests: ['Programming', 'Music']
          },
          // More nearby users...
        ],
        
        // Computed
        get filteredChats() {
          return this.chats.filter(chat => 
            chat.name.toLowerCase().includes(this.searchQuery.toLowerCase()) ||
            chat.lastMessage.toLowerCase().includes(this.searchQuery.toLowerCase())
          );
        },
        
        get currentChat() {
          return this.chats.find(chat => chat.id === this.activeChat) || null;
        },
        
        // Methods
        switchTab(tab) {
          this.currentTab = tab;
          if (tab !== 'chat') {
            this.activeChat = null;
          }
        },
        
        openChat(chat) {
          this.activeChat = chat.id;
          chat.unread = 0;
          this.$nextTick(() => {
            this.scrollToBottom();
          });
        },
        
        sendMessage() {
          if (!this.messageInput.trim()) return;
          
          const newMessage = {
            id: Date.now(),
            text: this.messageInput,
            time: new Date().toISOString(),
            sent: true,
            seen: false
          };
          
          this.currentChat.messages.push(newMessage);
          this.currentChat.lastMessage = newMessage.text;
          this.currentChat.lastMessageTime = newMessage.time;
          this.messageInput = '';
          
          this.$nextTick(() => {
            this.scrollToBottom();
          });
          
          // Simulate reply
          setTimeout(() => {
            const reply = {
              id: Date.now(),
              text: "Thanks for your message!",
              time: new Date().toISOString(),
              sent: false,
              seen: true
            };
            this.currentChat.messages.push(reply);
            this.currentChat.lastMessage = reply.text;
            this.currentChat.lastMessageTime = reply.time;
            
            this.$nextTick(() => {
              this.scrollToBottom();
            });
          }, 1000);
        },
        
        scrollToBottom() {
          const container = document.getElementById('messages-container');
          if (container) {
            container.scrollTop = container.scrollHeight;
          }
        },
        
        formatTime(timeString) {
          const date = new Date(timeString);
          return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        },
        
        formatMessageTime(timeString) {
          const date = new Date(timeString);
          return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        },
        
        toggleTheme() {
          this.darkMode = !this.darkMode;
          localStorage.setItem('darkMode', this.darkMode);
        },
        
        toggleUserMenu() {
          this.showUserMenu = !this.showUserMenu;
        },
        
        setTyping() {
          this.typing = true;
          clearTimeout(this.typingTimeout);
          this.typingTimeout = setTimeout(() => {
            this.typing = false;
          }, 2000);
        },
        
        attachFile(type) {
          alert(`Attaching ${type}`);
          this.showAttachments = false;
        },
        
        showMessageMenu(messageId) {
          this.messageMenu = this.messageMenu === messageId ? null : messageId;
        },
        
        replyToMessage(message) {
          this.messageInput = `Replying to "${message.text}": `;
          this.messageMenu = null;
          document.querySelector('.input-container input').focus();
        },
        
        copyMessage(message) {
          navigator.clipboard.writeText(message.text);
          this.messageMenu = null;
        },
        
        deleteMessage(message) {
          this.currentChat.messages = this.currentChat.messages.filter(m => m.id !== message.id);
          this.messageMenu = null;
        },
        
        forwardMessage(message) {
          alert(`Forwarding: ${message.text}`);
          this.messageMenu = null;
        },
        
        startCall(type) {
          alert(`Starting ${type} call`);
        },
        
        viewProfile() {
          alert('Viewing profile');
        },
        
        clearChat() {
          if (confirm('Clear all messages in this chat?')) {
            this.currentChat.messages = [];
          }
          this.showChatOptions = false;
        },
        
        deleteChat() {
          if (confirm('Delete this chat?')) {
            this.chats = this.chats.filter(chat => chat.id !== this.activeChat);
            this.activeChat = null;
          }
          this.showChatOptions = false;
        },
        
        findPeople() {
          this.currentTab = 'location';
        },
        
        refreshLocation() {
          alert('Refreshing location...');
        },
        
        sendRequest(userId) {
          alert(`Sending connection request to user ${userId}`);
        },
        
        logout() {
          if (confirm('Are you sure you want to logout?')) {
            alert('Logged out');
          }
          this.showUserMenu = false;
        },
        
        init() {
          // Load theme preference
          if (localStorage.getItem('darkMode') !== null) {
            this.darkMode = localStorage.getItem('darkMode') === 'true';
          }
          
          // Initialize emoji picker
          const picker = document.querySelector('emoji-picker');
          if (picker) {
            picker.addEventListener('emoji-click', event => {
              this.messageInput += event.detail.unicode;
              this.showEmojiPicker = false;
            });
          }
        }
      }));
    });
  </script>
</body>
</html>